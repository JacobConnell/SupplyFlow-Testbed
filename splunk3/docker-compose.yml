version: '3'
services:
    splunk.supply.com:
        container_name: splunk.supply.com
        image: splunk/splunk:8.1
        environment:
            - SPLUNK_START_ARGS=--accept-license
            - SPLUNK_PASSWORD=changeme
            - SPLUNK_HEC_TOKEN=00000000-0000-0000-0000-000000000000
            - SPLUNK_APPS_URL=http://s3.amazonaws.com/splunk-hyperledger/status-indicator-custom-visualization_130.tgz,https://github.com/splunkdlt/splunk-hyperledger-fabric/releases/download/2.0.2/splunk-hyperledger-fabric-v2.0.2.tgz
        ports:
            - '8000:8000'
        volumes:
            - ./splunk.yml:/tmp/defaults/default.yml
    otelcollector.supply.com:
        container_name: otelcollector.supply.com
        image: otel/opentelemetry-collector-contrib:0.13.0
        command: ['--config=/etc/otel-collector-config.yml']
        volumes:
            - ./otel-collector-config.yml:/etc/otel-collector-config.yml
        ports:
            - '1888:1888' # pprof extension
            - '8888:8888' # Prometheus metrics exposed by the collector
            - '8889:8889' # Prometheus exporter metrics
            - '13133:13133' # health_check extension
            - '55680:55680' # zpages extension
    fabric-logger.supply.com:
        restart: always
        depends_on:
            - splunk.supply.com
        container_name: fabric-logger.supply.com
        image: ghcr.io/splunkdlt/fabric-logger:latest
        volumes:
            - ./network-config.yml:/tmp/network-config.yml
            - ../vars/keyfiles:/crypto-config
            - ./fabriclogger.yml:/tmp/fabriclogger.yml
        environment:
            - FABRIC_KEYFILE=/crypto-config/peerOrganizations/distillery.supply.com/users/Admin@distillery.supply.com/msp/keystore/priv_sk
            - FABRIC_CERTFILE=/crypto-config/peerOrganizations/distillery.supply.com/users/Admin@distillery.supply.com/msp/signcerts/Admin@distillery.supply.com-cert.pem
            - FABRIC_CLIENT_KEYFILE=/crypto-config/peerOrganizations/distillery.supply.com/peers/peer1.distillery.supply.com/tls/server.key
            - FABRIC_CLIENT_CERTFILE=/crypto-config/peerOrganizations/distillery.supply.com/peers/peer1.distillery.supply.com/tls/server.crt
            - FABRIC_MSP=distillery-supply-com
            - FABRIC_LOGGER_USERNAME=Admin
            - FABRIC_PEER=peer1.distillery.supply.com
            - NETWORK_CONFIG=/tmp/network-config.yml
            - SPLUNK_HEC_TOKEN=00000000-0000-0000-0000-000000000000
            - SPLUNK_HEC_URL=https://splunk.supply.com:8088
            - SPLUNK_INDEX=hyperledger_logs
            - SPLUNK_HEC_REJECT_INVALID_CERTS=false
            - FABRIC_LOGGER_CONFIG=/tmp/fabriclogger.yml

networks:
    default:
        external:
            name: supplychain
